<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>.. model independent parameters · HybridVariationalInference.jl</title><meta name="title" content=".. model independent parameters · HybridVariationalInference.jl"/><meta property="og:title" content=".. model independent parameters · HybridVariationalInference.jl"/><meta property="twitter:title" content=".. model independent parameters · HybridVariationalInference.jl"/><meta name="description" content="Documentation for HybridVariationalInference.jl."/><meta property="og:description" content="Documentation for HybridVariationalInference.jl."/><meta property="twitter:description" content="Documentation for HybridVariationalInference.jl."/><meta property="og:url" content="https://EarthyScience.github.io/HybridVariationalInference.jl/tutorials/blocks_corr/"/><meta property="twitter:url" content="https://EarthyScience.github.io/HybridVariationalInference.jl/tutorials/blocks_corr/"/><link rel="canonical" href="https://EarthyScience.github.io/HybridVariationalInference.jl/tutorials/blocks_corr/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">HybridVariationalInference.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../problem/">Problem</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../basic_cpu/">Basic workflow</a></li><li><a class="tocitem" href="../inspect_results/">Inspect results</a></li></ul></li><li><span class="tocitem">How to</span><ul><li class="is-active"><a class="tocitem" href>.. model independent parameters</a><ul class="internal"><li><a class="tocitem" href="#Motivation"><span>Motivation</span></a></li><li><a class="tocitem" href="#Specifying-blocks-in-correlation-structure"><span>Specifying blocks in correlation structure</span></a></li><li><a class="tocitem" href="#Reinitialize-parameters-for-the-posterior-approximation."><span>Reinitialize parameters for the posterior approximation.</span></a></li><li><a class="tocitem" href="#Update-the-problem-and-redo-the-inversion"><span>Update the problem and redo the inversion</span></a></li><li><a class="tocitem" href="#Compare-the-correated-vs.-uncorrelated-posterior"><span>Compare the correated vs. uncorrelated posterior</span></a></li></ul></li><li><a class="tocitem" href="../corr_site_global/">.. model site-global corr</a></li><li><a class="tocitem" href="../lux_gpu/">.. use GPU</a></li></ul></li><li><span class="tocitem">Explanation</span></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="../../reference/reference_public/">Public</a></li><li><a class="tocitem" href="../../reference/reference_internal/">Internal</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How to</a></li><li class="is-active"><a href>.. model independent parameters</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>.. model independent parameters</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/EarthyScience/HybridVariationalInference.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/EarthyScience/HybridVariationalInference.jl/blob/main/docs/src/tutorials/blocks_corr.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="How-to-model-indenpendent-parameter-blocks-in-the-posterior"><a class="docs-heading-anchor" href="#How-to-model-indenpendent-parameter-blocks-in-the-posterior">How to model indenpendent parameter-blocks in the posterior</a><a id="How-to-model-indenpendent-parameter-blocks-in-the-posterior-1"></a><a class="docs-heading-anchor-permalink" href="#How-to-model-indenpendent-parameter-blocks-in-the-posterior" title="Permalink"></a></h1><p>This guide shows how to configure independent parameter-blocks in the correlations of the posterior.</p><h2 id="Motivation"><a class="docs-heading-anchor" href="#Motivation">Motivation</a><a id="Motivation-1"></a><a class="docs-heading-anchor-permalink" href="#Motivation" title="Permalink"></a></h2><p>Modelling all correlations among global and site PBM-parameters respectively requires many degrees of freedom.</p><p>To decrease the number of parameters to estimate, HVI allows to decompose the correlations into independent sub-blocks of parameters.</p><p>First load necessary packages.</p><pre><code class="language-julia hljs">using HybridVariationalInference
using ComponentArrays: ComponentArrays as CA
using Bijectors
using SimpleChains
using MLUtils
using JLD2
using Random
using CairoMakie
using PairPlots   # scatterplot matrices</code></pre><p>This tutorial reuses and modifies the fitted object saved at the end of the <a href="../basic_cpu/#Basic-workflow-without-GPU">Basic workflow without GPU</a> tutorial.</p><pre><code class="language-julia hljs">fname = &quot;intermediate/basic_cpu_results.jld2&quot;
print(abspath(fname))
prob = probo_cor = load(fname, &quot;probo&quot;);</code></pre><h2 id="Specifying-blocks-in-correlation-structure"><a class="docs-heading-anchor" href="#Specifying-blocks-in-correlation-structure">Specifying blocks in correlation structure</a><a id="Specifying-blocks-in-correlation-structure-1"></a><a class="docs-heading-anchor-permalink" href="#Specifying-blocks-in-correlation-structure" title="Permalink"></a></h2><p>HVI models the posterior of the parameters at unconstrained scale using a multivariate normal distribution. It estimates a parameterization of the associated blocks in the correlation matrx and requires a specification of the block-structure.</p><p>This is done by specifying the positions of the end of the blocks for the global (P) and the site-specific parameters (M) respectively using a <code>NamedTuple</code> of integer vectors.</p><p>The defaults specifies a single entry, meaning, there is only one big block respectively, spanning all parameters.</p><pre><code class="language-julia hljs">cor_ends0 = (P=[length(prob.θP)], M=[length(prob.θM)])</code></pre><pre><code class="nohighlight hljs">(P = [1], M = [2])</code></pre><p>The following specification models one-entry blocks for each each parameter in the correlation block the site parameters, i.e. treating all parameters independently with not modelling any correlations between them.</p><pre><code class="language-julia hljs">cor_ends = (P=[length(prob.θP)], M=1:length(prob.θM))</code></pre><pre><code class="nohighlight hljs">(P = [1], M = 1:2)</code></pre><h2 id="Reinitialize-parameters-for-the-posterior-approximation."><a class="docs-heading-anchor" href="#Reinitialize-parameters-for-the-posterior-approximation.">Reinitialize parameters for the posterior approximation.</a><a id="Reinitialize-parameters-for-the-posterior-approximation.-1"></a><a class="docs-heading-anchor-permalink" href="#Reinitialize-parameters-for-the-posterior-approximation." title="Permalink"></a></h2><p>HVI uses additional fitted parameters to represent the means and the covariance matrix of the posterior distribution of model parameters. With fewer correlations, also the number of those parameters changes, and those parameters must be reinitialized after changing the block structure in the correlation matrix.</p><p>Here, we obtain construct initial estimates. using <a href="../../reference/reference_public/#HybridVariationalInference.init_hybrid_ϕunc-Union{Tuple{NamedTuple}, Tuple{FT}, Tuple{NamedTuple, FT}, Tuple{NamedTuple, FT, AbstractVector{FT}}} where FT"><code>init_hybrid_ϕunc</code></a></p><pre><code class="language-julia hljs">ϕunc = init_hybrid_ϕunc(cor_ends, zero(eltype(prob.θM)))</code></pre><p>In this two-site parameter case, the the blocked structure saves only one degree of freedom:</p><pre><code class="language-julia hljs">length(ϕunc), length(probo_cor.ϕunc)</code></pre><pre><code class="nohighlight hljs">(5, 6)</code></pre><h2 id="Update-the-problem-and-redo-the-inversion"><a class="docs-heading-anchor" href="#Update-the-problem-and-redo-the-inversion">Update the problem and redo the inversion</a><a id="Update-the-problem-and-redo-the-inversion-1"></a><a class="docs-heading-anchor-permalink" href="#Update-the-problem-and-redo-the-inversion" title="Permalink"></a></h2><pre><code class="language-julia hljs">prob_ind = HybridProblem(prob; cor_ends, ϕunc)</code></pre><pre><code class="language-julia hljs">using OptimizationOptimisers
import Zygote

solver = HybridPosteriorSolver(; alg=Adam(0.02), n_MC=3)

(; probo) = solve(prob_ind, solver; 
    callback = callback_loss(100), # output during fitting
    epochs = 20,
); probo_ind = probo;</code></pre><h2 id="Compare-the-correated-vs.-uncorrelated-posterior"><a class="docs-heading-anchor" href="#Compare-the-correated-vs.-uncorrelated-posterior">Compare the correated vs. uncorrelated posterior</a><a id="Compare-the-correated-vs.-uncorrelated-posterior-1"></a><a class="docs-heading-anchor-permalink" href="#Compare-the-correated-vs.-uncorrelated-posterior" title="Permalink"></a></h2><p>First, draw a sample.</p><pre><code class="language-julia hljs">n_sample_pred = 400
(y_cor, θsP_cor, θsMs_cor) = (; y, θsP, θsMs) = predict_hvi(
  Random.default_rng(), probo_cor; n_sample_pred)
(y_ind, θsP_ind, θsMs_ind) = (; y, θsP, θsMs) = predict_hvi(
  Random.default_rng(), probo_ind; n_sample_pred)</code></pre><pre><code class="language-julia hljs">i_site = 1
θ1 = vcat(θsP_ind, θsMs_ind[i_site,:,:])
θ1_nt = NamedTuple(k =&gt; CA.getdata(θ1[k,:]) for k in keys(θ1[:,1])) # 
plt = pairplot(θ1_nt)</code></pre><p><img src="../blocks_corr_files/figure-commonmark/cell-11-output-1.png" alt/></p><p>The corner plot of the independent-parameters estimate shows no correlations between site parameters, <em>r</em>₁ and <em>K</em>₁.</p><pre><code class="language-julia hljs">i_out = 4
fig = Figure(); ax = Axis(fig[1,1], xlabel=&quot;mean(y)&quot;,ylabel=&quot;sd(y)&quot;)
ymean_cor = [mean(y_cor[i_out,s,:]) for s in axes(y_cor, 2)]
ysd_cor = [std(y_cor[i_out,s,:]) for s in axes(y_cor, 2)]
scatter!(ax, ymean_cor, ysd_cor, label=&quot;correlated&quot;) 
ymean_ind = [mean(y_ind[i_out,s,:]) for s in axes(y_ind, 2)]
ysd_ind = [std(y_ind[i_out,s,:]) for s in axes(y_ind, 2)]
scatter!(ax, ymean_ind, ysd_ind, label=&quot;independent&quot;) 
axislegend(ax, unique=true)
fig</code></pre><p><img src="../blocks_corr_files/figure-commonmark/cell-12-output-1.png" alt/></p><pre><code class="language-julia hljs">plot_sd_vs_mean = (par) -&gt; begin
  fig = Figure(); ax = Axis(fig[1,1], xlabel=&quot;mean($par)&quot;,ylabel=&quot;sd($par)&quot;)
  θmean_cor = [mean(θsMs_cor[s,par,:]) for s in axes(θsMs_cor, 1)]
  θsd_cor = [std(θsMs_cor[s,par,:]) for s in axes(θsMs_cor, 1)]
  scatter!(ax, θmean_cor, θsd_cor, label=&quot;correlated&quot;) 
  θmean_ind = [mean(θsMs_ind[s,par,:]) for s in axes(θsMs_ind, 1)]
  θsd_ind = [std(θsMs_ind[s,par,:]) for s in axes(θsMs_ind, 1)]
  scatter!(ax, θmean_ind, θsd_ind, label=&quot;independent&quot;) 
  axislegend(ax, unique=true)
  fig
end
plot_sd_vs_mean(:K1)</code></pre><p><img src="../blocks_corr_files/figure-commonmark/cell-13-output-1.png" alt/></p><p>The inversion that neglects correlations among site parameters results in the same magnitude of estimated uncertainty of predictions. However, the uncertainty of the model parameters is severely underestimated in this example.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../inspect_results/">« Inspect results</a><a class="docs-footer-nextpage" href="../corr_site_global/">.. model site-global corr »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Thursday 21 August 2025 10:08">Thursday 21 August 2025</span>. Using Julia version 1.11.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
